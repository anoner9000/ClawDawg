Peabody Review — heartbeat_aggregator.sh

Task: peabody-review-heartbeat-2026-02-08T2146
Artifact: ~/.openclaw/workspace/scripts/heartbeat_aggregator.sh
Reviewer: Peabody (L2 — Developer-Reviewer)
Timestamp: 2026-02-08T21:54:00Z

SUMMARY
- I reviewed heartbeat_aggregator.sh for the stated provenance and gating invariants. The script largely implements the intended flow: it builds canonical instructions, writes request JSON, calls the OpenAI Responses API, writes the response file, attempts usage append, marks processed entries, and clears the queue on success.

PASS / FAIL (high-level)
- Provenance writes: PASS (instructions_*.txt, request_*.json, llm_response_*.json are produced).
- Rate-guard semantics: PARTIAL (script invokes rate_guard --check before work; on HTTP 429 it records via rate_guard --record — good; confirm only 429s are recorded.)
- Idempotent accounting: PARTIAL (usage_append_from_latest_response.sh is idempotent by source path — good). Aggregator currently calls the append script and swallows failures but writes accounting_incomplete flag — acceptable per task constraint.
- Queue gating at proposal entry: NOT APPLICABLE (the aggregator is downstream; proposal‑service gating not in scope of this script review).

FINDINGS (detailed)
1) Provenance ordering: instructions file is written before request JSON and before API call — OK. Request JSON is built from INSTR_FILE and batch_prompt; REQ_FILE is printed and used. Time‑based filenames use date -Iseconds which is acceptable for uniqueness but can contain colons — some filesystems/tools may treat colons specially; consider using date +%Y%m%dT%H%M%S%z for cleaner filenames.

2) HTTP error handling: On non-2xx responses the script checks if HTTP_CODE == "429" and calls rate_guard.sh --record --code 429 — good. It prints the response snippet and exits 1 (queue NOT cleared). This matches the gating requirement.

3) Usage append behavior: The script calls usage_append_from_latest_response.sh and captures stderr to a temp file. On failure it records an accounting_incomplete_<ts>.flag and writes details to usage_append_failures.log — then continues to mark processed and clear queue. This follows your operational constraint (do not fail aggregator on append failure) but leaves a risk that accounting is incomplete while queue cleared. This is acceptable per policy but requires an active repair workflow.

4) Race conditions / temp files: The script uses mktemp for APPEND_ERR_FILE but does not explicitly secure it (mktemp is fine). Ensure the temp dir is not world-writable in your runtime.

5) File size guard: INSTR_FILE size check (>60KB abort) is a good hard guard to avoid giant payloads. Consider logging a summary of biggest contributing files when near the limit to aid debugging.

6) Environment and secrets: The script reads OPENAI_API_KEY from runtime credentials; ensure the runtime secrets file is mode 600 and not world-readable. The script uses : "${OPENAI_API_KEY:?OPENAI_API_KEY not set}" which will abort if missing — good fail‑fast.

7) Filename character safety: As noted, date -Iseconds produces colons; when these files are referenced by other tools (e.g., Windows paths) colons can be problematic. Recommend switching to date +%Y%m%dT%H%M%S%z or using sanitized timestamps.

PROPOSED CHANGES (minimal, reversible)
- Change timestamp format for generated files to avoid colons.
- Add explicit file creation ownership/permission step for INSTR_FILE/REQ_FILE/RESP_FILE so provenance files are 640 (owner read/write, group read) to avoid exposing tokens in some environments.

Verification commands (dry-run / read-only)
1) Verify instruction file writing and size guard:
   wc -c "$INSTR_FILE" && tail -n 20 "$INSTR_FILE"
2) Simulate a non-2xx response and confirm rate_guard recorded 429 (dry-run):
   (Set OPENAI_API_KEY to invalid) run aggregator; check ~/.openclaw/runtime/logs/heartbeat/ratelimit_counter.json
3) Simulate append failure and verify accounting_incomplete flag created:
   make ledger file readonly and run the append script against a sample response; check ~/.openclaw/runtime/logs/heartbeat/usage_append_failures.log and accounting_incomplete_*.flag

RECOMMENDATION
- Approve for staged rollout; implement the two small, reversible fixes (timestamp format + file permission hardening). Create a short repair play for accounting_incomplete flags (automated alert to Deiphobe + single command to retry usage append on flagged responses).

End of Peabody review (draft).
