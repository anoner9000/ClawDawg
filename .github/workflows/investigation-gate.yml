name: investigation-gate

on:
  pull_request:

jobs:
  investigation-gate:
    runs-on: ubuntu-latest

    # Least privilege: no write perms, no PR writes, no checks writes, etc.
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Sanity check (stable check name + wheel ABI)
        run: |
          set -euo pipefail
          # Confirm the required check context will remain stable:
          echo "expected required check context: investigation-gate / investigation-gate"
          # Confirm rpds_py wheel ABI matches configured Python (e.g. cp312 for 3.12):
          PYVER=$(python -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
          TAG="cp${PYVER/./}"
          echo "python: ${PYVER} => ABI tag: ${TAG}"
          RPDS=$(ls -1 ops/vendor/wheels/rpds_py-*-"${TAG}"-*.whl 2>/dev/null | head -n1 || true)
          [ -n "${RPDS}" ] || { echo "ERROR: rpds_py wheel missing for ABI ${TAG}"; exit 1; }
          echo "rpds wheel: $(basename "$RPDS")"
          echo "$(basename "$RPDS")" | grep -q "${TAG}" || {
            echo "ERROR: rpds wheel ABI mismatch: expected ${TAG} in filename";
            exit 1;
          }
      - name: Install deps (offline from vendored wheels)
        run: |
          set -euo pipefail

          test -d ops/vendor/wheels
          test -f ops/vendor/requirements/investigation_gate.txt

          python -m pip install \
            --no-index \
            --find-links ops/vendor/wheels \
            -r ops/vendor/requirements/investigation_gate.txt

      - name: Run investigation gate(s)
        run: |
          set -euo pipefail

          RUN_DIRS=$( (find runtime/investigations -maxdepth 2 -type f -name claims.json -printf '%h\n' 2>/dev/null || true; find investigations -maxdepth 2 -type f -name claims.json -printf '%h\n' 2>/dev/null || true) | sort -u )

          if [ -z "${RUN_DIRS}" ]; then
            echo "No investigation runs found under runtime/investigations/** or investigations/**"
            exit 0
          fi

          echo "Found investigation run dirs:"
          echo "${RUN_DIRS}"

          while IFS= read -r dir; do
            run_id="$(basename "${dir}")"
            echo "---- gate: ${dir} (run_id=${run_id}) ----"
            python ops/scripts/investigation/investigation_gate.py "${dir}" "${run_id}"
            if [ -f "${dir}/adjudication.json" ]; then
              echo "---- adjudication.json (${dir}) ----"
              cat "${dir}/adjudication.json" || true
            fi
          done <<< "${RUN_DIRS}"

      - name: Upload investigation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: investigation-runs
          path: |
            runtime/investigations/**
            investigations/**
          if-no-files-found: ignore
